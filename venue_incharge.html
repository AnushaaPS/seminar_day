<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Venue Incharge - View Marks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="common.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    .logout-btn {
  background-color: #ff4d4d;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  position: absolute;
  top: 15px;
  right: 20px;
}
.logout-btn:hover {
  background-color: #e60000;
}

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #a8edea, #fed6e3);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      padding: 30px;
      width: 95%;
      max-width: 1100px;
      animation: fadeIn 1s ease;
    }

    h2 {
      color: #2c3e50;
      font-weight: 700;
      text-align: center;
      margin-bottom: 15px;
    }

    #welcome {
      text-align: center;
      margin-bottom: 20px;
      font-weight: 500;
      color: #444;
    }

    label {
      font-weight: 600;
      color: #333;
      margin-right: 10px;
    }

    select {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
      font-size: 14px;
      margin-right: 10px;
    }

    button {
      background: linear-gradient(90deg, #007bff, #00c6ff);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button:hover {
      transform: scale(1.05);
      background: linear-gradient(90deg, #00c6ff, #007bff);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px 6px;
      text-align: center;
      font-size: 14px;
    }

    th {
      background: #007bff;
      color: white;
    }

    tr:nth-child(even) {
      background: #f8f9fa;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive table for mobile */
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead {
        display: none;
      }
      tr {
        margin-bottom: 15px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 0 5px rgba(0,0,0,0.1);
        padding: 10px;
      }
      td {
        border: none;
        display: flex;
        justify-content: space-between;
        text-align: left;
        padding: 6px 10px;
        font-size: 14px;
      }
      td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #007bff;
      }
    }
  </style>
</head>
<body onload="initVenueIncharge()">

  <div class="container">
    <h2><i class="bi bi-building-fill-gear"></i> Venue Incharge Dashboard</h2>
    <div id="welcome"></div>

    <div style="text-align:center; margin-bottom:20px;">
      <label for="batchSelect"><i class="bi bi-calendar-check"></i> Select Batch:</label>
      <select id="batchSelect">
        <option value="">-- Select Batch --</option>
        <option value="FN">FN</option>
        <option value="AN">AN</option>
      </select>
      <button id="logoutBtn" class="logout-btn">Logout</button>
      <button onclick="fetchVenueMarks()"><i class="bi bi-eye-fill"></i> View Marks</button>
      <button onclick="downloadVenueReport()"><i class="bi bi-file-earmark-arrow-down-fill"></i> Download PDF</button>
    </div>

    <table id="marksTable" style="display:none;">
      <thead>
        <tr>
          <th>Faculty ID</th>
          <th>Team ID</th>
          <th>Student ID</th>
          <th>Student Name</th>
          <th>Dept</th>
          <th>Venue</th>
          <th>Level I - Self-Introduction</th>
          <th>Level I - Presentation</th>
          <th>Level I - Content</th>
          <th>Level I - Response</th>
          <th>Level II - Determination</th>
          <th>Level II - Communication</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    setupLogout();
    const faculty_id = localStorage.getItem("faculty_id");
    const facultyName = localStorage.getItem("faculty_name");
    const venue = localStorage.getItem("venue");
    const role = localStorage.getItem("role");

    function initVenueIncharge() {
      if (!faculty_id || role !== "VenueIncharge") {
        alert("Unauthorized access! Please login again.");
        window.location.href = "index.html";
        return;
      }

      document.getElementById("welcome").innerHTML =
        `Welcome <b>${facultyName}</b> — Role: <b>${role}</b> — Venue: <b>${venue}</b>`;
    }

    async function fetchVenueMarks() {
      const batch = document.getElementById("batchSelect").value;
      if (!batch) {
        alert("Please select a batch first!");
        return;
      }

      const res = await postData("getVenueMarks", { batch });
      const marks = Array.isArray(res) ? res : res.data || [];
      const filtered = marks.filter(m => (m.Venue || "").trim().toLowerCase() === venue.trim().toLowerCase());
      const tbody = document.querySelector("#marksTable tbody");
      tbody.innerHTML = "";

      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="13">No marks found for ${venue} (${batch})</td></tr>`;
        document.getElementById("marksTable").style.display = "table";
        return;
      }

      filtered.forEach(m => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td data-label="Faculty ID">${m.Faculty_ID || ""}</td>
          <td data-label="Team ID">${m.TeamID || ""}</td>
          <td data-label="Student ID">${m.Student_ID || ""}</td>
          <td data-label="Student Name">${m.Student_Name || ""}</td>
          <td data-label="Dept">${m.Dept || ""}</td>
          <td data-label="Venue">${m.Venue || ""}</td>
          <td data-label="Level I - Introduction">${m.LevelI_Self_Introduction || 0}</td>
          <td data-label="Level I - Presentation">${m.LevelI_Presentation || 0}</td>
          <td data-label="Level I - Content">${m.LevelI_Content || 0}</td>
          <td data-label="Level I - Response">${m.LevelI_Response || 0}</td>
          <td data-label="Level II - Determination">${m.LevelII_Determination || 0}</td>
          <td data-label="Level II - Communication">${m.LevelII_Communication || 0}</td>
          <td data-label="Total">${m.Total || 0}</td>`;
        tbody.appendChild(tr);
      });

      document.getElementById("marksTable").style.display = "table";
    }

    async function getLogoData() {
      const logoUrl = "logo.jpeg";
      try {
        const resp = await fetch(logoUrl);
        if (!resp.ok) throw new Error("Logo not found");
        const blob = await resp.blob();
        const bitmap = await createImageBitmap(blob);
        const canvas = document.createElement("canvas");
        canvas.width = bitmap.width;
        canvas.height = bitmap.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(bitmap, 0, 0);
        return canvas.toDataURL("image/jpeg");
      } catch (e) {
        console.warn("Logo load failed:", e);
        return null;
      }
    }

    async function downloadVenueReport() {
      const batch = document.getElementById("batchSelect").value;
      if (!batch) {
        alert("Please select a batch first!");
        return;
      }

      const res = await postData("getMarks", { batch });
      const marks = Array.isArray(res) ? res : res.data || [];
      const filtered = marks.filter(m => (m.Venue || "").trim().toLowerCase() === venue.trim().toLowerCase());

      if (!filtered.length) {
        alert(`No marks found for ${venue} (${batch})`);
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF("landscape", "pt", "a4");
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const logoData = await getLogoData();
      const generatedDate = new Date().toLocaleString();

      doc.setFont("times", "bold");
      doc.setFontSize(18);
      doc.text("SEMINAR DAY EVALUATION REPORT", pageWidth / 2, 100, { align: "center" });
      doc.setFontSize(12);
      doc.text(`Batch: ${batch}`, pageWidth - 120, 120);

      const head = [[
        "Faculty ID", "Team ID", "Student ID", "Student Name", "Dept", "Venue",
        "Level I - Self Introduction", "Level I - Presentation", "Level I - Content",
        "Level I - Response", "Level II - Determination", "Level II - Communication", "Total"
      ]];

      const body = filtered.map(m => [
        m.Faculty_ID || "", m.TeamID || "", m.Student_ID || "", m.Student_Name || "",
        m.Dept || "", m.Venue || "", m.LevelI_Self_Introduction || 0, m.LevelI_Presentation || 0,
        m.LevelI_Content || 0, m.LevelI_Response || 0, m.LevelII_Determination || 0,
        m.LevelII_Communication || 0, m.Total || 0
      ]);

      const headerHeight = 130;

      doc.autoTable({
        head, body,
        startY: headerHeight,
        theme: "grid",
        styles: { font: "times", fontSize: 10, cellPadding: 4, halign: "center", valign: "middle" },
        headStyles: { fillColor: [240, 240, 240], textColor: 0 },
        columnStyles: { 3: { halign: "left" } },
        didDrawPage: function () {
          if (logoData) {
            const logoWidth = 250, logoHeight = 50;
            doc.addImage(logoData, "JPEG", (pageWidth - logoWidth) / 2, 20, logoWidth, logoHeight);
          }
        },
      });

      const finalY = doc.lastAutoTable.finalY + 30;
const sigY = finalY + 60;

// Footer - generated time
doc.setFont("times", "normal");
doc.text(`Generated on: ${generatedDate}`, 625, finalY);

// If signature goes beyond the page → add new page
if (sigY > pageHeight - 40) {
    doc.addPage();
    doc.setFont("times", "bold");
    doc.text("Venue Incharge Signature", pageWidth - 60, 40, { align: "right" });
    doc.text("Faculty Signature", pageWidth - 660, 40, { align: "right" });
} else {
    doc.setFont("times", "bold");
    doc.text("Venue Incharge Signature", pageWidth - 60, sigY, { align: "right" });
    doc.text("Faculty 1 Signature", pageWidth - 660, 40, { align: "right" });
}


      doc.save(`${venue}_${batch}_Seminar_Report.pdf`);
    }
  </script>
</body>
</html>

