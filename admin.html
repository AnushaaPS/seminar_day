<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="common.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    .logout-btn {
  background-color: #ff4d4d;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  position: absolute;
  top: 15px;
  right: 20px;
}
.logout-btn:hover {
  background-color: #e60000;
}
    :root{
      --primary:#4285f4; --primary-dark:#3367d6; --danger:#d93025;
      --bg:#f9fafc; --card:#fff; --muted:#666;
    }
    *{box-sizing:border-box}
    body{
      font-family:"Poppins",sans-serif;
      margin:0;
      background:var(--bg);
      color:#222;
      -webkit-font-smoothing:antialiased;
    }
    header{
      background: linear-gradient(135deg,var(--primary),var(--primary-dark));
      color:white;padding:16px 20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.08);
    }
    header h1{margin:0;font-size:20px}
    main{max-width:1100px;margin:18px auto;padding:16px}
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(320px,1fr));
      gap:18px;
    }
    section{
      background:var(--card);padding:18px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.04);
      transition:transform .12s,box-shadow .12s;
    }
    section:hover{transform:translateY(-3px);box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    h2{margin:0 0 12px 0;color:var(--primary-dark);font-size:16px;border-left:4px solid var(--primary);padding-left:10px}
    label{display:block;margin:8px 0 6px;font-weight:600}
    select,input[type=file]{width:100%;padding:8px;border:1px solid #d7dce9;border-radius:8px}
    .btn{display:inline-block;background:var(--primary);color:#fff;padding:9px 14px;border-radius:8px;border:0;cursor:pointer;margin:6px 6px 0 0;font-weight:600}
    .btn:hover{background:var(--primary-dark)}
    .btn-danger{background:var(--danger)}
    .muted{color:var(--muted)}
    #status,#uploadStatus{margin-top:10px;font-weight:700;color:#333}
    @media(max-width:480px){
      header h1{font-size:16px}
      .btn{width:100%}
    }
    hr{border:none;border-top:1px dashed #e6e9f2;margin:14px 0}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .row .col{flex:1;min-width:120px}
  </style>
</head>
<body>
  <header><h1>Admin Dashboard</h1></header>

  <main>
    <div class="grid">
      <button id="logoutBtn" class="logout-btn">Logout</button>
      <!-- Lock/Unlock -->
      <section>
        <h2>üîí Lock / Unlock Marks Entry (by Batch)</h2>
        <label>Select Batch:</label>
        <select id="batchSelect">
          <option value="">-- Select Batch --</option>
          <option value="FN">FN</option>
          <option value="AN">AN</option>
        </select>

        <div style="margin-top:8px">
          <button class="btn" onclick="toggleLock('Open')">Unlock Marks Entry</button>
          <button class="btn btn-danger" onclick="toggleLock('Closed')">Lock Marks Entry</button>
        </div>
        <div id="status"></div>
      </section>

      <!-- Uploads -->
      <section>
        <h2>üìÅ Upload Data Sheets</h2>

        <label>Download Templates:</label>
        <div class="row" style="margin-bottom:8px">
          <div class="col"><button class="btn" onclick="downloadStaticTemplate('student')">Student Details Template</button></div>
          <div class="col"><button class="btn" onclick="downloadStaticTemplate('faculty')">Faculty Login Template</button></div>
        </div>

        <hr>

        <label>Student Details Sheet:</label>
        <input type="file" id="studentSheet" accept=".xlsx,.xls,.csv">
        <button class="btn" onclick="uploadSheet('studentSheet', 'uploadStudentSheet')">Upload</button>

        <label style="margin-top:12px">Faculty Login Details Sheet:</label>
        <input type="file" id="facultySheet" accept=".xlsx,.xls,.csv">
        <button class="btn" onclick="uploadSheet('facultySheet', 'uploadFacultySheet')">Upload</button>

        <div id="uploadStatus"></div>
      </section>

      <!-- Reports -->
      <section>
        <h2>üìÑ Download Reports</h2>

        <label>Select Department:</label>
        <select id="deptSelect"></select>

        <label style="margin-top:10px">Select Batch:</label>
        <select id="reportBatch">
          <option value="FN">FN</option>
          <option value="AN">AN</option>
        </select>

        <div style="margin-top:10px">
          <button class="btn" onclick="downloadDeptReport()">Report (PDF)</button>
          <button class="btn" onclick="downloadDeptReportCSV()">Department Report (CSV)</button>
          <button class="btn" onclick="downloadTotalDeptReport()">Total Report (PDF)</button>
          <button class="btn" onclick="downloadTotalDeptReportCSV()">Total Report (CSV)</button>
        </div>
      </section>

    </div>
  </main>

  <script>
    setupLogout();
    // Keep normalize helper unchanged
    const normalize = v => String(v || "").trim().toLowerCase();

    function addPageNumbers(doc) {
  const pageCount = doc.internal.getNumberOfPages();
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();

  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(9);
    doc.setFont("times", "normal");
    doc.text(
      `Page ${i} of ${pageCount}`,
      pageWidth / 2,
      pageHeight - 20,
      { align: "center" }
    );
  }
}

    // getLogoData (unchanged logic)
    async function getLogoData() {
      const logoUrl = "logo.jpeg"; // ensure correct path or keep null fallback
      try {
        const resp = await fetch(logoUrl);
        if (!resp.ok) throw new Error("Logo not found");
        const blob = await resp.blob();
        const bitmap = await createImageBitmap(blob);
        const canvas = document.createElement("canvas");
        canvas.width = bitmap.width;
        canvas.height = bitmap.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(bitmap, 0, 0);
        return canvas.toDataURL("image/jpeg");
      } catch (e) {
        console.warn("Logo load failed:", e);
        return null;
      }
    }

    // ---------- Existing postData usage preserved ----------
    // NOTE: postData is expected to be provided by common.js / your environment.
    // Example: await postData("getStudents", { venue: "ALL" });

    // Toggle Lock/Unlock (same logic)
    async function toggleLock(status) {
      const batch = document.getElementById("batchSelect").value;
      if (!batch) return alert("Please select a batch first!");
      await postData("setLock", { batch, status });
      document.getElementById("status").textContent = `Marks entry for ${batch} batch is now ${status}`;
    }

    // Download static csv templates (same CSV content as original)
    function downloadStaticTemplate(type) {
      let csvContent = "";
      if (type === "student") {
        csvContent =
`TeamID,Student1_ID,Student1_Name,Student2_ID,Student2_Name,Dept,Title,Venue,Batch
T001,22CS001,Anushaa P S,22CS002,Anu,CSE,AI-Based Traffic Control,Hall-1,FN`;
      } else if (type === "faculty") {
        csvContent =
`Faculty_ID,Name,Password,Role,Venue,Batch
F001,Dr. xxx,pass123,Faculty,Hall-1,FN`;
      }

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = type === "student" ? "Student_Details_Template.csv" : "Faculty_Login_Template.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // Upload sheets (same logic using FileReader + postData)
    async function uploadSheet(inputId, functionName) {
      const fileInput = document.getElementById(inputId);
      const file = fileInput.files[0];
      if (!file) return alert("Please select a file before uploading!");
      const reader = new FileReader();
      reader.onload = async e => {
        await postData(functionName, { fileData: e.target.result, fileName: file.name });
        document.getElementById("uploadStatus").innerHTML = `${file.name} uploaded successfully.`;
        if (functionName === "uploadStudentSheet") populateDeptDropdown();
      };
      reader.readAsDataURL(file);
    }

    // Populate department dropdown (preserve logic)
    async function populateDeptDropdown() {
      try {
        const students = await postData("getStudents", { venue: "ALL" });
        const deptSelect = document.getElementById("deptSelect");
        deptSelect.innerHTML = "";

        const allOpt = document.createElement("option");
        allOpt.value = "ALL";
        allOpt.textContent = "All Departments";
        deptSelect.appendChild(allOpt);

        const depts = [...new Set(students.map(s => s.Dept || s.dept || "").filter(d => d))];
        depts.forEach(d => {
          const opt = document.createElement("option");
          opt.value = d;
          opt.textContent = d;
          deptSelect.appendChild(opt);
        });
      } catch (err) {
        console.error("populateDeptDropdown error:", err);
      }
    }

    // === Department Report (PDF) ===
    async function downloadDeptReport() {
      const dept = document.getElementById("deptSelect").value;
      const batch = document.getElementById("reportBatch").value;

      // Fetch marks data from backend
      const marksResp = await postData("getMarks", { batch });
      const marks = Array.isArray(marksResp) ? marksResp : marksResp.data || [];

      console.log("Marks fetched:", marks);

      // Filter department-wise
      const filtered =
        dept === "ALL"
          ? marks
          : marks.filter(
              (m) => (m.Dept || "").trim().toLowerCase() === dept.trim().toLowerCase()
            );

      if (!filtered.length) {
        alert("No marks data found for this department.");
        return;
      }

      // Prepare PDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF("landscape", "pt", "a4");
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const logoData = await getLogoData();
      const generatedDate = new Date().toLocaleString();

      doc.setFont("times", "bold");
      doc.setFontSize(18);
      doc.text("SEMINAR DAY EVALUATION REPORT", pageWidth / 2, 100, { align: "center" });

      doc.setFontSize(12);
      doc.text(`Department: ${dept}`, 60, 120);
      doc.text(`Batch: ${batch}`, pageWidth - 120, 120);

      // Table header & body (preserve original fields)
      const head = [
        [
          "Faculty ID",
          "Team ID",
          "Student ID",
          "Student Name",
          "Dept",
          "Venue",
          "Level I - Self-Introduction",
          "Level I - Presentation",
          "Level I - Content",
          "Level I - Response",
          "Level II - Determination",
          "Level II - Communication",
          "Total",
        ],
      ];

      // Sort by Student_ID
filtered.sort((a, b) => (a.Student_ID || "").localeCompare(b.Student_ID || ""));

// Now prepare table data
const body = filtered.map((m) => [
  m.Faculty_ID || "",
  m.TeamID || "",
  m.Student_ID || "",
  m.Student_Name || "",
  m.Dept || "",
  m.Venue || "",
  m.LevelI_Self_Introduction || 0,
  m.LevelI_Presentation || 0,
  m.LevelI_Content || 0,
  m.LevelI_Response || 0,
  m.LevelII_Determination || 0,
  m.LevelII_Communication || 0,
  m.Total || 0,
]);


      const headerHeight = 150;

      doc.autoTable({
        head: head,
        body: body,
        startY: headerHeight,
        theme: "grid",
        styles: {
          font: "times",
          fontSize: 10,
          textColor: 0,
          cellPadding: 4,
          lineColor: 0,
          lineWidth: 0.5,
          halign: "center",
          valign: "middle",
        },
        headStyles: {
          fillColor: [255, 255, 255],
          textColor: 0,
          lineColor: 0,
          lineWidth: 0.5,
          halign: "center",
          valign: "middle"
        },
        columnStyles: {
          3: { halign: "left" }, // Student Name aligned left
        },
        didDrawPage: function (data) {
          if (data.pageNumber === 1 && logoData) {
            const logoWidth = 250, logoHeight = 50;
    doc.addImage(
      logoData,
      "JPEG",
      (pageWidth - logoWidth) / 2,
      20,
      logoWidth,
      logoHeight
    );
          }
        },
      });

      const finalY = doc.lastAutoTable.finalY + 60;
      doc.setFontSize(12);
      doc.setFont("times", "bold");

      if (dept === "ALL") {
        doc.text("Dean Academic Courses", pageWidth - 40, finalY + 20, { align: "right" });
      } else {
        doc.text("HoD", pageWidth - 740, finalY + 20);
        doc.text("Dean Academic Courses", pageWidth - 40, finalY + 20, { align: "right" });
      }
      doc.setFont("times", "normal");
      doc.text(`Generated on: ${generatedDate}`, pageWidth - 200, finalY + 40);
      addPageNumbers(doc);
      doc.save(`${dept}_${batch}_Seminar_Report.pdf`);
    }

    // === Department CSV Download ===
    async function downloadDeptReportCSV() {
      const dept = document.getElementById("deptSelect").value;
      const batch = document.getElementById("reportBatch").value;

      // Fetch marks from Apps Script backend
      const marksResp = await postData("getMarks", { batch });
      const marks = Array.isArray(marksResp) ? marksResp : marksResp.data || [];

      console.log("Marks fetched:", marks);

      // Filter department-wise
      const filtered = dept === "ALL"
        ? marks
        : marks.filter(
            (m) =>
              (m.Dept || "").trim().toLowerCase() === dept.trim().toLowerCase()
          );

      if (!filtered.length)
        return alert("No marks data found for this department.");

      // Header columns (match your sheet)
      const header = [
        "Faculty_ID",
        "TeamID",
        "Student_ID",
        "Student_Name",
        "Dept",
        "Venue",
        "LevelI_Self_Introduction",
        "LevelI_Presentation",
        "LevelI_Content",
        "LevelI_Response",
        "LevelII_Determination",
        "LevelII_Communication",
        "Total",
        "Batch",
      ];

      // Construct CSV content
      let csv = header.join(",") + "\n";
      filtered.forEach((m) => {
        csv += [
          m.Faculty_ID || "",
          m.TeamID || "",
          m.Student_ID || "",
          m.Student_Name || "",
          m.Dept || "",
          m.Venue || "",
          m.LevelI_Self_Introduction|| "",
          m.LevelI_Presentation || "",
          m.LevelI_Content || "",
          m.LevelI_Response || "",
          m.LevelII_Determination || "",
          m.LevelII_Communication || "",
          m.Total || "",
          m.Batch || "",
        ].join(",") + "\n";
      });

      // Create and download CSV file
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${dept}_${batch}_Seminar_Report.csv`;
      a.click();
    }

    // === Total Dept Report CSV Download ===
async function downloadTotalDeptReportCSV() {
  const dept = document.getElementById("deptSelect").value;
  const batch = document.getElementById("reportBatch").value;

  // Fetch marks data from backend
  const marksResp = await postData("getMarks", { batch });
  const marks = Array.isArray(marksResp) ? marksResp : marksResp.data || [];

  // Filter department-wise
  const filtered =
    dept === "ALL"
      ? marks
      : marks.filter(
          (m) => (m.Dept || "").trim().toLowerCase() === dept.trim().toLowerCase()
        );

  if (!filtered.length) {
    alert("No marks data found for this department.");
    return;
  }

  // Group by Student_ID
  const grouped = {};
  filtered.forEach((m) => {
    const sid = (m.Student_ID || "").trim();
    if (!sid) return;
    if (!grouped[sid]) {
      grouped[sid] = {
        Student_ID: sid,
        Student_Name: (m.Student_Name || "").trim(),
        Dept: m.Dept || "",
        Marks: [],
      };
    }
    grouped[sid].Marks.push(Number(m.Total) || 0);
  });

  // Prepare rows
  const rows = Object.values(grouped).map((s) => {
    const mark1 = s.Marks[0] || 0;
    const mark2 = s.Marks[1] || 0;
    const avg = mark1 === 0 && mark2 === 0 ? "Absent" : Math.ceil((mark1 + mark2) / 2);
    return [s.Student_ID, s.Student_Name, s.Dept, mark1, mark2, avg];
  });

  // Create CSV content
  const header = ["Student_ID", "Student_Name", "Dept", "Mark1", "Mark2", "Average"];
  let csv = header.join(",") + "\n";
  rows.forEach(r => { csv += r.join(",") + "\n"; });

  // Download CSV
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${dept}_${batch}_Total_Seminar_Report.csv`;
  a.click();
}

    // === Total Dept Report (Group by Student) ===
    async function downloadTotalDeptReport() {
      const dept = document.getElementById("deptSelect").value;
      const batch = document.getElementById("reportBatch").value;

      // Fetch marks data from backend
      const marksResp = await postData("getMarks", { batch });
      const marks = Array.isArray(marksResp) ? marksResp : marksResp.data || [];

      console.log("Marks fetched:", marks);

      // Filter department-wise
      const filtered =
        dept === "ALL"
          ? marks
          : marks.filter(
              (m) => (m.Dept || "").trim().toLowerCase() === dept.trim().toLowerCase()
            );

      if (!filtered.length) {
        alert("No marks data found for this department.");
        return;
      }

      // === Group by Student_ID to calculate Mark1, Mark2, and Average ===
      const grouped = {};
      filtered.forEach((m) => {
        const sid = (m.Student_ID || "").trim();
        if (!sid) return;
        if (!grouped[sid]) {
          grouped[sid] = {
            Student_ID: sid,
            Student_Name: m.Student_Name || "",
            Dept: m.Dept || "",
            Marks: [],
          };
        }
        grouped[sid].Marks.push(Number(m.Total) || 0);
      });

      // Convert grouped data into table rows
      const combined = Object.values(grouped)
  .sort((a, b) => (a.Student_ID || "").localeCompare(b.Student_ID || ""))
  .map((s) => {

        const mark1 = s.Marks[0] || 0;
        const mark2 = s.Marks[1] || 0;
        let avg = Math.ceil((mark1 + mark2) / 2);
        if (avg == 0) {
          avg = "Absent";
        }
        return [
          s.Student_ID,
          s.Student_Name,
          s.Dept,
          mark1,
          mark2,
          avg,
        ];
      });

      // === Prepare PDF ===
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const logoData = await getLogoData();
      const generatedDate = new Date().toLocaleString();

      doc.setFont("times", "bold");
      doc.setFontSize(18);
      doc.text("SEMINAR DAY TOTAL REPORT", pageWidth / 2, 40, { align: "center" });

      doc.setFontSize(12);
      doc.text(`Department: ${dept}`, 20, 50);
      doc.text(`Batch: ${batch}`, pageWidth - 40, 50);

      // Table
      const head = [["Student ID", "Student Name", "Dept", "Mark 1", "Mark 2", "Average"]];

      doc.autoTable({
        head,
        body: combined,
        startY: 60,
        theme: "grid",
        styles: {
          font: "times",
          fontSize: 10,
          textColor: 0,
          cellPadding: 2,
          lineColor: 0,
          lineWidth: 0.5,
          halign: "center",
          valign: "middle",
        },
        headStyles: {
          fillColor: [255, 255, 255],
          textColor: 0,
          lineColor: 0,
          lineWidth: 0.5,
          halign: "center",
          valign: "middle",
          fontStyle: "bold",
        },
        columnStyles: {
          1: { halign: "left" }, // Student Name aligned left
        },
        didDrawPage: function (data) {
          if (data.pageNumber === 1 && logoData) {
            const logoWidth = 100, logoHeight = 20;
    doc.addImage(
      logoData,
      "JPEG",
      (pageWidth - logoWidth) / 2,
      20,
      logoWidth,
      logoHeight
    );
          }
        },
      });

      const finalY = doc.lastAutoTable.finalY + 60;
      doc.setFontSize(12);
      doc.setFont("times", "bold");

      if (dept === "ALL") {
        doc.text("Dean Academic Courses", pageWidth - 27, finalY, { align: "right" });
      } else {
        doc.text("HoD", 30, finalY);
        doc.text("Dean Academic Courses", pageWidth - 27, finalY, { align: "right" });
      }

      // Generated Timestamp
      doc.setFont("times", "normal");
      doc.setFontSize(10);
      doc.text(`Generated on: ${generatedDate}`, pageWidth - 75, finalY + 10);
      addPageNumbers(doc);
      doc.save(`${dept}_${batch}_Total_Seminar_Report.pdf`);
    }

    // Initialize on load
    document.addEventListener("DOMContentLoaded", function(){
      // if postData exists, populate dropdown; otherwise logger
      if (typeof postData === "function") {
        populateDeptDropdown();
      } else {
        console.warn("postData() is not defined. Ensure common.js provides postData or adapt accordingly.");
      }
    });
  </script>
</body>
</html>